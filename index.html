<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì˜¨ë¼ì¸ ì±„íŒ…</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #root {
            width: 100%;
            max-width: 1200px;
            padding: 20px;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // ìš•ì„¤ í•„í„° ë¦¬ìŠ¤íŠ¸
        const profanityList = [
            'ì‹œë°œ', 'ì”¨ë°œ', 'ê°œìƒˆ', 'ë³‘ì‹ ', 'ì§€ë„', 'ì¢†', 'ì”¹', 'nigga', 
            'ë¯¸ì¹œ', 'ë˜ë¼ì´', 'ì—¼ë³‘', 'ì—¿', 'ê°œìì‹', 'ìƒˆë¼', 'ë…„', 
            'ì“°ë ˆê¸°', 'ê°œXX', 'ì¡´ë‚˜', 'fuck', 'shit', 'bitch', 'ass',
            'êº¼ì ¸', 'ì£½ì–´', 'ë©ì²­ì´', 'ë°”ë³´', 'ë“±ì‹ ', 'ë†ˆ', 'ë‡¬',
            'ì• ë¯¸', 'ì• ë¹„', 'í˜¸ë¡œ', 'ì°½ë…€', 'ì…', 'ë‹ˆì• ë¯¸', 'ëŠê¸ˆ'
        ];

        // ìš•ì„¤ í•„í„° í•¨ìˆ˜
        function filterProfanity(text) {
            let filtered = text;
            profanityList.forEach(word => {
                const regex = new RegExp(word, 'gi');
                filtered = filtered.replace(regex, (match) => '*'.repeat(match.length));
            });
            return filtered;
        }

        // ë¡œê·¸ì¸/íšŒì›ê°€ì… ì»´í¬ë„ŒíŠ¸
        function AuthScreen({ onLogin }) {
            const [isLogin, setIsLogin] = useState(true);
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [confirmPassword, setConfirmPassword] = useState('');
            const [error, setError] = useState('');

            const handleSubmit = async (e) => {
                e.preventDefault();
                setError('');

                if (!username.trim() || !password.trim()) {
                    setError('ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }

                if (username.length < 3) {
                    setError('ì•„ì´ë””ëŠ” 3ê¸€ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
                    return;
                }

                if (password.length < 4) {
                    setError('ë¹„ë°€ë²ˆí˜¸ëŠ” 4ê¸€ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
                    return;
                }

                if (isLogin) {
                    // ë¡œê·¸ì¸
                    try {
                        const result = await window.storage.get(`user:${username}`, true);
                        if (result && result.value) {
                            const userData = JSON.parse(result.value);
                            if (userData.password === password) {
                                onLogin(username);
                            } else {
                                setError('ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                            }
                        } else {
                            setError('ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ì•„ì´ë””ì…ë‹ˆë‹¤.');
                        }
                    } catch (err) {
                        setError('ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ì•„ì´ë””ì…ë‹ˆë‹¤.');
                    }
                } else {
                    // íšŒì›ê°€ì…
                    if (password !== confirmPassword) {
                        setError('ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                        return;
                    }

                    try {
                        const existingUser = await window.storage.get(`user:${username}`, true);
                        if (existingUser) {
                            setError('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì•„ì´ë””ì…ë‹ˆë‹¤.');
                            return;
                        }
                    } catch (err) {
                        // ì‚¬ìš©ìê°€ ì—†ìœ¼ë©´ ì •ìƒ (ì—ëŸ¬ ë¬´ì‹œ)
                    }

                    const userData = {
                        username,
                        password,
                        joinedAt: new Date().toISOString()
                    };

                    await window.storage.set(`user:${username}`, JSON.stringify(userData), true);
                    alert('íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
                    setIsLogin(true);
                    setPassword('');
                    setConfirmPassword('');
                }
            };

            return (
                <div style={{
                    background: 'white',
                    borderRadius: '20px',
                    padding: '40px',
                    boxShadow: '0 20px 60px rgba(0,0,0,0.3)',
                    maxWidth: '400px',
                    margin: '0 auto'
                }}>
                    <h1 style={{
                        textAlign: 'center',
                        color: '#667eea',
                        marginBottom: '30px',
                        fontSize: '32px'
                    }}>
                        ğŸ’¬ ì˜¨ë¼ì¸ ì±„íŒ…
                    </h1>

                    <div style={{
                        display: 'flex',
                        marginBottom: '30px',
                        borderRadius: '10px',
                        overflow: 'hidden',
                        border: '2px solid #e0e0e0'
                    }}>
                        <button
                            onClick={() => setIsLogin(true)}
                            style={{
                                flex: 1,
                                padding: '15px',
                                border: 'none',
                                background: isLogin ? '#667eea' : 'white',
                                color: isLogin ? 'white' : '#666',
                                fontSize: '16px',
                                fontWeight: 'bold',
                                cursor: 'pointer',
                                transition: 'all 0.3s'
                            }}
                        >
                            ë¡œê·¸ì¸
                        </button>
                        <button
                            onClick={() => setIsLogin(false)}
                            style={{
                                flex: 1,
                                padding: '15px',
                                border: 'none',
                                background: !isLogin ? '#667eea' : 'white',
                                color: !isLogin ? 'white' : '#666',
                                fontSize: '16px',
                                fontWeight: 'bold',
                                cursor: 'pointer',
                                transition: 'all 0.3s'
                            }}
                        >
                            íšŒì›ê°€ì…
                        </button>
                    </div>

                    <form onSubmit={handleSubmit}>
                        <input
                            type="text"
                            placeholder="ì•„ì´ë”” (3ê¸€ì ì´ìƒ)"
                            value={username}
                            onChange={(e) => setUsername(e.target.value)}
                            style={{
                                width: '100%',
                                padding: '15px',
                                marginBottom: '15px',
                                border: '2px solid #e0e0e0',
                                borderRadius: '10px',
                                fontSize: '16px',
                                outline: 'none',
                                transition: 'border 0.3s'
                            }}
                            onFocus={(e) => e.target.style.borderColor = '#667eea'}
                            onBlur={(e) => e.target.style.borderColor = '#e0e0e0'}
                        />

                        <input
                            type="password"
                            placeholder="ë¹„ë°€ë²ˆí˜¸ (4ê¸€ì ì´ìƒ)"
                            value={password}
                            onChange={(e) => setPassword(e.target.value)}
                            style={{
                                width: '100%',
                                padding: '15px',
                                marginBottom: '15px',
                                border: '2px solid #e0e0e0',
                                borderRadius: '10px',
                                fontSize: '16px',
                                outline: 'none',
                                transition: 'border 0.3s'
                            }}
                            onFocus={(e) => e.target.style.borderColor = '#667eea'}
                            onBlur={(e) => e.target.style.borderColor = '#e0e0e0'}
                        />

                        {!isLogin && (
                            <input
                                type="password"
                                placeholder="ë¹„ë°€ë²ˆí˜¸ í™•ì¸"
                                value={confirmPassword}
                                onChange={(e) => setConfirmPassword(e.target.value)}
                                style={{
                                    width: '100%',
                                    padding: '15px',
                                    marginBottom: '15px',
                                    border: '2px solid #e0e0e0',
                                    borderRadius: '10px',
                                    fontSize: '16px',
                                    outline: 'none',
                                    transition: 'border 0.3s'
                                }}
                                onFocus={(e) => e.target.style.borderColor = '#667eea'}
                                onBlur={(e) => e.target.style.borderColor = '#e0e0e0'}
                            />
                        )}

                        {error && (
                            <div style={{
                                background: '#ffe0e0',
                                color: '#d00',
                                padding: '12px',
                                borderRadius: '8px',
                                marginBottom: '15px',
                                fontSize: '14px',
                                textAlign: 'center'
                            }}>
                                {error}
                            </div>
                        )}

                        <button
                            type="submit"
                            style={{
                                width: '100%',
                                padding: '15px',
                                background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                                color: 'white',
                                border: 'none',
                                borderRadius: '10px',
                                fontSize: '18px',
                                fontWeight: 'bold',
                                cursor: 'pointer',
                                transition: 'transform 0.2s',
                                boxShadow: '0 4px 15px rgba(102, 126, 234, 0.4)'
                            }}
                            onMouseEnter={(e) => e.target.style.transform = 'translateY(-2px)'}
                            onMouseLeave={(e) => e.target.style.transform = 'translateY(0)'}
                        >
                            {isLogin ? 'ë¡œê·¸ì¸' : 'íšŒì›ê°€ì…'}
                        </button>
                    </form>
                </div>
            );
        }

        // ì±„íŒ… ì»´í¬ë„ŒíŠ¸
        function ChatScreen({ username, onLogout }) {
            const [messages, setMessages] = useState([]);
            const [inputMessage, setInputMessage] = useState('');
            const [onlineUsers, setOnlineUsers] = useState(new Set());
            const messagesEndRef = useRef(null);
            const lastMessageId = useRef(0);

            // ë©”ì‹œì§€ ë¡œë“œ
            useEffect(() => {
                loadMessages();
                const interval = setInterval(loadMessages, 1000);
                return () => clearInterval(interval);
            }, []);

            // ì˜¨ë¼ì¸ ì‚¬ìš©ì ì—…ë°ì´íŠ¸
            useEffect(() => {
                updateOnlineStatus();
                const interval = setInterval(updateOnlineStatus, 5000);
                return () => clearInterval(interval);
            }, [username]);

            // ìë™ ìŠ¤í¬ë¡¤
            useEffect(() => {
                messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
            }, [messages]);

            const loadMessages = async () => {
                try {
                    const result = await window.storage.get('chat:messages', true);
                    if (result && result.value) {
                        const msgs = JSON.parse(result.value);
                        setMessages(msgs);
                        if (msgs.length > 0) {
                            lastMessageId.current = msgs[msgs.length - 1].id;
                        }
                    }
                } catch (err) {
                    // ë©”ì‹œì§€ê°€ ì—†ìœ¼ë©´ ë¬´ì‹œ
                }
            };

            const updateOnlineStatus = async () => {
                const now = Date.now();
                await window.storage.set(`online:${username}`, now.toString(), true);

                try {
                    const keys = await window.storage.list('online:', true);
                    if (keys && keys.keys) {
                        const users = new Set();
                        for (const key of keys.keys) {
                            try {
                                const result = await window.storage.get(key, true);
                                if (result && result.value) {
                                    const lastSeen = parseInt(result.value);
                                    if (now - lastSeen < 10000) {
                                        const user = key.replace('online:', '');
                                        users.add(user);
                                    }
                                }
                            } catch (err) {
                                // ì—ëŸ¬ ë¬´ì‹œ
                            }
                        }
                        setOnlineUsers(users);
                    }
                } catch (err) {
                    // ì—ëŸ¬ ë¬´ì‹œ
                }
            };

            const sendMessage = async (e) => {
                e.preventDefault();
                if (!inputMessage.trim()) return;

                const filteredMessage = filterProfanity(inputMessage);
                const newMessage = {
                    id: lastMessageId.current + 1,
                    username,
                    text: filteredMessage,
                    timestamp: new Date().toISOString(),
                    isFiltered: filteredMessage !== inputMessage
                };

                const updatedMessages = [...messages, newMessage];
                
                // ìµœê·¼ 100ê°œ ë©”ì‹œì§€ë§Œ ìœ ì§€
                if (updatedMessages.length > 100) {
                    updatedMessages.shift();
                }

                await window.storage.set('chat:messages', JSON.stringify(updatedMessages), true);
                setMessages(updatedMessages);
                lastMessageId.current = newMessage.id;
                setInputMessage('');
            };

            const formatTime = (timestamp) => {
                const date = new Date(timestamp);
                return date.toLocaleTimeString('ko-KR', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
            };

            return (
                <div style={{
                    display: 'flex',
                    gap: '20px',
                    height: '600px'
                }}>
                    {/* ì‚¬ì´ë“œë°” */}
                    <div style={{
                        width: '250px',
                        background: 'white',
                        borderRadius: '20px',
                        padding: '20px',
                        boxShadow: '0 10px 30px rgba(0,0,0,0.2)',
                        display: 'flex',
                        flexDirection: 'column'
                    }}>
                        <div style={{
                            marginBottom: '20px',
                            paddingBottom: '20px',
                            borderBottom: '2px solid #e0e0e0'
                        }}>
                            <div style={{
                                fontSize: '18px',
                                fontWeight: 'bold',
                                color: '#667eea',
                                marginBottom: '10px'
                            }}>
                                ğŸ‘¤ {username}
                            </div>
                            <button
                                onClick={onLogout}
                                style={{
                                    width: '100%',
                                    padding: '10px',
                                    background: '#ff6b6b',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '8px',
                                    cursor: 'pointer',
                                    fontSize: '14px',
                                    fontWeight: 'bold',
                                    transition: 'background 0.3s'
                                }}
                                onMouseEnter={(e) => e.target.style.background = '#ff5252'}
                                onMouseLeave={(e) => e.target.style.background = '#ff6b6b'}
                            >
                                ë¡œê·¸ì•„ì›ƒ
                            </button>
                        </div>

                        <div>
                            <div style={{
                                fontSize: '16px',
                                fontWeight: 'bold',
                                marginBottom: '15px',
                                color: '#333'
                            }}>
                                ğŸŸ¢ ì˜¨ë¼ì¸ ({onlineUsers.size})
                            </div>
                            <div style={{
                                maxHeight: '400px',
                                overflowY: 'auto'
                            }}>
                                {Array.from(onlineUsers).map(user => (
                                    <div
                                        key={user}
                                        style={{
                                            padding: '10px',
                                            background: user === username ? '#e8f4ff' : '#f5f5f5',
                                            borderRadius: '8px',
                                            marginBottom: '8px',
                                            fontSize: '14px',
                                            color: '#333'
                                        }}
                                    >
                                        {user === username ? `${user} (ë‚˜)` : user}
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>

                    {/* ì±„íŒ… ì˜ì—­ */}
                    <div style={{
                        flex: 1,
                        background: 'white',
                        borderRadius: '20px',
                        boxShadow: '0 10px 30px rgba(0,0,0,0.2)',
                        display: 'flex',
                        flexDirection: 'column',
                        overflow: 'hidden'
                    }}>
                        {/* í—¤ë” */}
                        <div style={{
                            padding: '20px',
                            background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                            color: 'white',
                            fontSize: '20px',
                            fontWeight: 'bold'
                        }}>
                            ğŸ’¬ ì „ì²´ ì±„íŒ…ë°©
                        </div>

                        {/* ë©”ì‹œì§€ ëª©ë¡ */}
                        <div style={{
                            flex: 1,
                            overflowY: 'auto',
                            padding: '20px',
                            background: '#f9f9f9'
                        }}>
                            {messages.length === 0 ? (
                                <div style={{
                                    textAlign: 'center',
                                    color: '#999',
                                    marginTop: '50px',
                                    fontSize: '16px'
                                }}>
                                    ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´ì„œ ëŒ€í™”ë¥¼ ì‹œì‘í•˜ì„¸ìš”!
                                </div>
                            ) : (
                                messages.map((msg) => (
                                    <div
                                        key={msg.id}
                                        style={{
                                            marginBottom: '15px',
                                            display: 'flex',
                                            justifyContent: msg.username === username ? 'flex-end' : 'flex-start'
                                        }}
                                    >
                                        <div style={{
                                            maxWidth: '70%'
                                        }}>
                                            {msg.username !== username && (
                                                <div style={{
                                                    fontSize: '12px',
                                                    color: '#667eea',
                                                    fontWeight: 'bold',
                                                    marginBottom: '5px'
                                                }}>
                                                    {msg.username}
                                                </div>
                                            )}
                                            <div style={{
                                                background: msg.username === username 
                                                    ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' 
                                                    : 'white',
                                                color: msg.username === username ? 'white' : '#333',
                                                padding: '12px 16px',
                                                borderRadius: msg.username === username 
                                                    ? '18px 18px 4px 18px' 
                                                    : '18px 18px 18px 4px',
                                                boxShadow: '0 2px 5px rgba(0,0,0,0.1)',
                                                wordWrap: 'break-word'
                                            }}>
                                                {msg.text}
                                                {msg.isFiltered && (
                                                    <div style={{
                                                        fontSize: '10px',
                                                        marginTop: '5px',
                                                        opacity: 0.7
                                                    }}>
                                                        âš ï¸ ë¶€ì ì ˆí•œ ì–¸ì–´ê°€ í•„í„°ë§ë˜ì—ˆìŠµë‹ˆë‹¤
                                                    </div>
                                                )}
                                            </div>
                                            <div style={{
                                                fontSize: '11px',
                                                color: '#999',
                                                marginTop: '5px',
                                                textAlign: msg.username === username ? 'right' : 'left'
                                            }}>
                                                {formatTime(msg.timestamp)}
                                            </div>
                                        </div>
                                    </div>
                                ))
                            )}
                            <div ref={messagesEndRef} />
                        </div>

                        {/* ì…ë ¥ í¼ */}
                        <form
                            onSubmit={sendMessage}
                            style={{
                                padding: '20px',
                                borderTop: '2px solid #e0e0e0',
                                display: 'flex',
                                gap: '10px'
                            }}
                        >
                            <input
                                type="text"
                                value={inputMessage}
                                onChange={(e) => setInputMessage(e.target.value)}
                                placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."
                                style={{
                                    flex: 1,
                                    padding: '15px',
                                    border: '2px solid #e0e0e0',
                                    borderRadius: '25px',
                                    fontSize: '16px',
                                    outline: 'none',
                                    transition: 'border 0.3s'
                                }}
                                onFocus={(e) => e.target.style.borderColor = '#667eea'}
                                onBlur={(e) => e.target.style.borderColor = '#e0e0e0'}
                            />
                            <button
                                type="submit"
                                style={{
                                    padding: '15px 30px',
                                    background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '25px',
                                    fontSize: '16px',
                                    fontWeight: 'bold',
                                    cursor: 'pointer',
                                    transition: 'transform 0.2s',
                                    boxShadow: '0 4px 15px rgba(102, 126, 234, 0.4)'
                                }}
                                onMouseEnter={(e) => e.target.style.transform = 'scale(1.05)'}
                                onMouseLeave={(e) => e.target.style.transform = 'scale(1)'}
                            >
                                ì „ì†¡
                            </button>
                        </form>
                    </div>
                </div>
            );
        }

        // ë©”ì¸ ì•±
        function App() {
            const [currentUser, setCurrentUser] = useState(null);

            const handleLogin = (username) => {
                setCurrentUser(username);
            };

            const handleLogout = async () => {
                if (currentUser) {
                    await window.storage.delete(`online:${currentUser}`, true);
                }
                setCurrentUser(null);
            };

            return (
                <div>
                    {!currentUser ? (
                        <AuthScreen onLogin={handleLogin} />
                    ) : (
                        <ChatScreen username={currentUser} onLogout={handleLogout} />
                    )}
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
